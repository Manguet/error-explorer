name: ğŸš€ Deploy via FTP to o2Switch

on:
  workflow_run:
    workflows: ["Tests & Quality Check"]
    types:
      - completed
    branches: [main]

env:
  PHP_VERSION: '8.2'
  NODE_VERSION: '18'

jobs:
  deploy:
    name: ğŸš€ Deploy to error-explorer.com (FTP)
    runs-on: ubuntu-latest

    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      # 1. RÃ©cupÃ©rer le code
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      # 2. Installer PHP
      - name: ğŸ˜ Setup PHP ${{ env.PHP_VERSION }}
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, dom, filter, gd, json, pdo, zip

      # 3. Installer Node.js
      - name: ğŸ“¦ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      # 4. Installer les dÃ©pendances
      - name: ğŸ“¦ Install dependencies
        run: |
          composer install --no-dev --optimize-autoloader --no-interaction --no-scripts
          npm ci

      # 5. Build des assets
      - name: ğŸ”¨ Build production assets
        run: npm run build

      # 6. VÃ©rifier les fichiers buildÃ©s
      - name: ğŸ” Check build files
        run: |
          echo "Fichiers dans public/build:"
          ls -la public/build/ || echo "Pas de dossier build"
          
          echo "Structure du projet:"
          find . -name "*.php" -o -name "*.js" -o -name "*.css" | head -20

      # 7. DÃ©ploiement FTP
      - name: ğŸ“¤ Deploy via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USER }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: 21
          protocol: ftp
          local-dir: ./
          server-dir: /public_html/
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/tests/**
            **/var/cache/**
            **/var/log/**
            **/.env.local
            **/.env.test
            **/.env.dev
            **/phpunit.xml.dist
            **/.php-cs-fixer.*
            **/webpack.config.js
            **/package*.json
            **/package-lock.json
            **/README.md
            **/.github/**
            **/.gitignore
            **/composer.lock
            **/symfony.lock

      # 8. Post-deployment
      - name: ğŸ§¹ Post-deployment cleanup
        run: |
          echo "âœ… Fichiers dÃ©ployÃ©s via FTP"
          echo "ğŸŒ Site: https://error-explorer.com"
          echo "ğŸ“… DÃ©ployÃ© le: $(date)"

      # 9. Notification de succÃ¨s
      - name: ğŸ‰ Deployment successful
        run: |
          echo "ğŸ‰ DÃ©ploiement FTP terminÃ© avec succÃ¨s!"
          echo "ğŸŒ Votre site est maintenant Ã  jour sur: https://error-explorer.com"
          echo "ğŸ“¦ Fichiers synchronisÃ©s via FTP vers o2Switch"
