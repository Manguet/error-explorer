name: ğŸš€ Deploy to Production

# DÃ©clenche le dÃ©ploiement seulement sur push main ET aprÃ¨s succÃ¨s des tests
on:
  workflow_run:
    workflows: ["Tests & Quality Check"]
    types:
      - completed
    branches: [main]

env:
  PHP_VERSION: '8.2'
  NODE_VERSION: '18'

jobs:
  deploy:
    name: ğŸš€ Deploy to error-explorer.com
    runs-on: ubuntu-latest

    # Ne dÃ©ployer que si les tests ont rÃ©ussi
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      # 1. RÃ©cupÃ©rer le code
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # NÃ©cessaire pour git

      # 2. Installer PHP
      - name: ğŸ˜ Setup PHP ${{ env.PHP_VERSION }}
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, dom, filter, gd, json, pdo, zip

      # 3. Installer Node.js
      - name: ğŸ“¦ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      # 4. Installer les dÃ©pendances pour le build
      - name: ğŸ“¦ Install dependencies
        run: |
          # PHP : production seulement
          composer install --no-dev --optimize-autoloader --no-interaction --no-scripts
          
          # Node.js : AVEC les dÃ©pendances de dev pour pouvoir builder
          npm ci

      # 5. Build des assets
      - name: ğŸ”¨ Build production assets
        run: |
          # Build avec Encore
          npm run build

      # 6. PrÃ©parer la clÃ© SSH
      - name: ğŸ”‘ Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts

      # 7. Synchroniser les fichiers vers o2Switch
      - name: ğŸ“¤ Deploy to server
        run: |
          # Exclure les fichiers de dÃ©veloppement
          rsync -avz --delete \
            --exclude='node_modules' \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='tests' \
            --exclude='var/cache' \
            --exclude='var/log' \
            --exclude='.env.local' \
            --exclude='.env.test' \
            --exclude='phpunit.xml.dist' \
            --exclude='.php-cs-fixer.*' \
            --exclude='webpack.config.js' \
            --exclude='package*.json' \
            --exclude='README.md' \
            ./ ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:${{ secrets.DEPLOY_PATH }}/

      # 8. ExÃ©cuter le script de dÃ©ploiement sur le serveur
      - name: ğŸ¯ Run deployment script
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            cd ${{ secrets.DEPLOY_PATH }}
            
            # CrÃ©er le script de dÃ©ploiement s'il n'existe pas
            if [ ! -f "scripts/deploy.sh" ]; then
              mkdir -p scripts
              cat > scripts/deploy.sh << 'EOF'
            #!/bin/bash
            set -e
            echo "ğŸš€ DÃ©ploiement simplifiÃ©..."
            
            # Installation des dÃ©pendances PHP
            composer install --no-dev --optimize-autoloader --no-interaction
            
            # Migrations
            php bin/console doctrine:migrations:migrate --no-interaction --env=prod || true
            
            # Cache
            php bin/console cache:clear --env=prod --no-debug
            php bin/console cache:warmup --env=prod --no-debug
            
            # Permissions
            chmod -R 755 var/cache var/log 2>/dev/null || true
            
            echo "âœ… DÃ©ploiement terminÃ©!"
            EOF
              chmod +x scripts/deploy.sh
            fi
            
            # ExÃ©cuter le dÃ©ploiement
            bash scripts/deploy.sh

      # 9. VÃ©rification de santÃ©
      - name: ğŸ¥ Health check
        run: |
          echo "VÃ©rification que le site est accessible..."
          sleep 10
          curl -f https://error-explorer.com || echo "âš ï¸ Site non accessible immÃ©diatement"

      # 10. Notification de succÃ¨s
      - name: ğŸ‰ Deployment successful
        run: |
          echo "ğŸ‰ DÃ©ploiement rÃ©ussi!"
          echo "ğŸŒ Site: https://error-explorer.com"
          echo "ğŸ“… DÃ©ployÃ© le: $(date)"
