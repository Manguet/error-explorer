{% extends 'emails/base_email.html.twig' %}

{% block title %}RÃ©sumÃ© quotidien - {{ project.name }} - Error Explorer{% endblock %}

{% block header_class %}email-header--{% if summary.hasErrors %}warning{% else %}success{% endif %}{% endblock %}

{% block status_badge %}
    <div class="status-badge">
        ğŸ“Š RÃ‰SUMÃ‰ QUOTIDIEN
    </div>
{% endblock %}

{% block email_title %}RÃ©sumÃ© quotidien{% endblock %}

{% block email_subtitle %}{{ project.name }} - {{ date|date('d/m/Y') }}{% endblock %}

{% block body %}
    <h2>Bonjour {{ user.firstName }},</h2>

    <p>Voici le rÃ©sumÃ© quotidien de l'activitÃ© de votre projet <strong>{{ project.name }}</strong> pour la journÃ©e du {{ date|date('d/m/Y') }}.</p>

    <!-- MÃ©triques principales -->
    <h3>ğŸ“Š MÃ©triques de la journÃ©e</h3>
    <div class="details-grid">
        <div class="detail-item" style="border-left-color: {% if summary.errorCount > 0 %}#ef4444{% else %}#10b981{% endif %};">
            <div class="detail-label">Nouvelles erreurs</div>
            <div class="detail-value" style="color: {% if summary.errorCount > 0 %}#dc2626{% else %}#059669{% endif %};">
                {{ summary.errorCount }}
            </div>
        </div>
        <div class="detail-item" style="border-left-color: #3b82f6;">
            <div class="detail-label">Occurrences totales</div>
            <div class="detail-value">{{ summary.totalOccurrences }}</div>
        </div>
        <div class="detail-item" style="border-left-color: #f59e0b;">
            <div class="detail-label">Erreurs rÃ©solues</div>
            <div class="detail-value">{{ summary.resolvedCount }}</div>
        </div>
        <div class="detail-item" style="border-left-color: #8b5cf6;">
            <div class="detail-label">Utilisateurs affectÃ©s</div>
            <div class="detail-value">{{ summary.affectedUsers }}</div>
        </div>
    </div>

    <!-- Statut global -->
    {% if summary.errorCount == 0 %}
        <div class="success-card">
            <div class="card-title">
                ğŸ‰ Excellente journÃ©e !
            </div>
            <div class="card-content">
                Aucune nouvelle erreur dÃ©tectÃ©e aujourd'hui. Votre application fonctionne parfaitement !
            </div>
        </div>
    {% else %}
        <div class="{% if summary.errorCount > 10 %}error-card{% else %}warning-card{% endif %}">
            <div class="card-title">
                {% if summary.errorCount > 10 %}
                    ğŸš¨ JournÃ©e avec beaucoup d'erreurs
                {% else %}
                    âš ï¸ Quelques erreurs dÃ©tectÃ©es
                {% endif %}
            </div>
            <div class="card-content">
                {{ summary.errorCount }} {% if summary.errorCount == 1 %}nouvelle erreur a Ã©tÃ© dÃ©tectÃ©e{% else %}nouvelles erreurs ont Ã©tÃ© dÃ©tectÃ©es{% endif %} aujourd'hui.
                {% if summary.errorCount > 10 %}
                    Nous recommandons une attention particuliÃ¨re.
                {% endif %}
            </div>
        </div>
    {% endif %}

    <!-- Top des erreurs -->
    {% if summary.topErrors and summary.topErrors|length > 0 %}
        <h3>ğŸ” Top des erreurs</h3>
        {% for error in summary.topErrors|slice(0, 5) %}
            <div class="{% if loop.index <= 2 %}error-card{% else %}warning-card{% endif %}" style="margin-bottom: 15px;">
                <div class="card-title" style="font-size: 16px;">
                    {{ error.exceptionClass }}
                </div>
                <div class="card-content">
                    <div style="font-size: 14px; margin-bottom: 10px;">
                        {{ error.message|slice(0, 100) }}{% if error.message|length > 100 %}...{% endif %}
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 12px; color: #64748b;">
                        <span>{{ error.occurrenceCount }} occurrence{{ error.occurrenceCount > 1 ? 's' : '' }}</span>
                        <span>{{ error.file|split('/')|last }}:{{ error.line }}</span>
                    </div>
                </div>
            </div>
        {% endfor %}
    {% endif %}

    <!-- Comparaison avec hier -->
    {% if summary.yesterdayComparison %}
        <h3>ğŸ“ˆ Comparaison avec hier</h3>
        <div class="details-grid">
            <div class="detail-item">
                <div class="detail-label">Erreurs</div>
                <div class="detail-value">
                    {% if summary.yesterdayComparison.errorsDiff > 0 %}
                        <span style="color: #dc2626;">+{{ summary.yesterdayComparison.errorsDiff }}</span>
                    {% elseif summary.yesterdayComparison.errorsDiff < 0 %}
                        <span style="color: #059669;">{{ summary.yesterdayComparison.errorsDiff }}</span>
                    {% else %}
                        <span style="color: #64748b;">= 0</span>
                    {% endif %}
                </div>
            </div>
            <div class="detail-item">
                <div class="detail-label">Occurrences</div>
                <div class="detail-value">
                    {% if summary.yesterdayComparison.occurrencesDiff > 0 %}
                        <span style="color: #dc2626;">+{{ summary.yesterdayComparison.occurrencesDiff }}</span>
                    {% elseif summary.yesterdayComparison.occurrencesDiff < 0 %}
                        <span style="color: #059669;">{{ summary.yesterdayComparison.occurrencesDiff }}</span>
                    {% else %}
                        <span style="color: #64748b;">= 0</span>
                    {% endif %}
                </div>
            </div>
            <div class="detail-item">
                <div class="detail-label">Utilisateurs</div>
                <div class="detail-value">
                    {% if summary.yesterdayComparison.usersDiff > 0 %}
                        <span style="color: #dc2626;">+{{ summary.yesterdayComparison.usersDiff }}</span>
                    {% elseif summary.yesterdayComparison.usersDiff < 0 %}
                        <span style="color: #059669;">{{ summary.yesterdayComparison.usersDiff }}</span>
                    {% else %}
                        <span style="color: #64748b;">= 0</span>
                    {% endif %}
                </div>
            </div>
            <div class="detail-item">
                <div class="detail-label">Tendance</div>
                <div class="detail-value">
                    {% if summary.yesterdayComparison.trend == 'up' %}
                        <span style="color: #dc2626;">ğŸ“ˆ Hausse</span>
                    {% elseif summary.yesterdayComparison.trend == 'down' %}
                        <span style="color: #059669;">ğŸ“‰ Baisse</span>
                    {% else %}
                        <span style="color: #64748b;">â¡ï¸ Stable</span>
                    {% endif %}
                </div>
            </div>
        </div>
    {% endif %}

    <!-- Environnements -->
    {% if summary.environmentStats and summary.environmentStats|length > 1 %}
        <h3>ğŸŒ RÃ©partition par environnement</h3>
        <div class="info-card">
            <div class="card-content">
                {% for env, stats in summary.environmentStats %}
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; {% if not loop.last %}border-bottom: 1px solid #e2e8f0;{% endif %}">
                        <strong>{{ env|title }}:</strong>
                        <span>{{ stats.errors }} erreur{{ stats.errors > 1 ? 's' : '' }} ({{ stats.occurrences }} occurrence{{ stats.occurrences > 1 ? 's' : '' }})</span>
                    </div>
                {% endfor %}
            </div>
        </div>
    {% endif %}

    <!-- Bouton dashboard -->
    <div class="btn-center">
        <a href="{{ dashboard_url }}" class="btn btn-primary">
            ğŸ“Š Voir le dashboard complet
        </a>
    </div>

    <!-- RÃ©sumÃ© de la semaine -->
    {% if summary.weekSummary %}
        <h3>ğŸ“… Cette semaine ({{ summary.weekSummary.startDate|date('d/m') }} - {{ summary.weekSummary.endDate|date('d/m') }})</h3>
        <div class="details-grid">
            <div class="detail-item">
                <div class="detail-label">Total erreurs</div>
                <div class="detail-value">{{ summary.weekSummary.totalErrors }}</div>
            </div>
            <div class="detail-item">
                <div class="detail-label">Jours sans erreur</div>
                <div class="detail-value">{{ summary.weekSummary.errorFreeDays }}/7</div>
            </div>
            <div class="detail-item">
                <div class="detail-label">Pic d'erreurs</div>
                <div class="detail-value">{{ summary.weekSummary.peakDay|date('d/m') }}</div>
            </div>
            <div class="detail-item">
                <div class="detail-label">Taux de rÃ©solution</div>
                <div class="detail-value">{{ summary.weekSummary.resolutionRate }}%</div>
            </div>
        </div>
    {% endif %}

    <!-- Actions recommandÃ©es -->
    {% if summary.recommendations and summary.recommendations|length > 0 %}
        <h3>ğŸ’¡ Actions recommandÃ©es</h3>
        <div class="info-card">
            <div class="card-content">
                <ul class="styled-list">
                    {% for recommendation in summary.recommendations %}
                        <li>{{ recommendation }}</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    {% endif %}

    <!-- Boutons d'action -->
    <div class="btn-center">
        <a href="{{ dashboard_url }}/errors" class="btn btn-secondary">
            ğŸ” Voir toutes les erreurs
        </a>
        <a href="{{ dashboard_url }}/analytics" class="btn btn-secondary">
            ğŸ“ˆ Analytics dÃ©taillÃ©s
        </a>
    </div>

    <!-- Performance gÃ©nÃ©rale -->
    <div class="{% if summary.errorCount == 0 %}success-card{% elseif summary.errorCount <= 5 %}info-card{% else %}warning-card{% endif %}">
        <div class="card-title">
            ğŸ“Š Performance gÃ©nÃ©rale
        </div>
        <div class="card-content">
            {% if summary.errorCount == 0 %}
                ğŸ¯ <strong>Excellent !</strong> Aucune erreur dÃ©tectÃ©e aujourd'hui.
            {% elseif summary.errorCount <= 5 %}
                âœ… <strong>Bon</strong> - Quelques erreurs mineures dÃ©tectÃ©es.
            {% elseif summary.errorCount <= 15 %}
                âš ï¸ <strong>Attention</strong> - Plusieurs erreurs nÃ©cessitent votre attention.
            {% else %}
                ğŸš¨ <strong>Critique</strong> - Beaucoup d'erreurs dÃ©tectÃ©es, intervention recommandÃ©e.
            {% endif %}
        </div>
    </div>

    <p class="text-center">
        Continuez Ã  surveiller vos applications avec Error Explorer !<br>
        <strong>L'Ã©quipe Error Explorer</strong>
    </p>
{% endblock %}

{% block additional_footer_links %}
    <a href="{{ dashboard_url }}" class="footer-link">Dashboard</a>
    <a href="{{ dashboard_url }}/settings/notifications" class="footer-link">GÃ©rer les notifications</a>
{% endblock %}

{% block footer_legal %}
    RÃ©sumÃ© quotidien Error Explorer pour {{ project.name }}<br>
    {{ "now"|date('d/m/Y Ã  H:i') }} | DonnÃ©es du {{ date|date('d/m/Y') }}
{% endblock %}
